// Main Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

// Import all modular schemas
import * from "./schemas/core"
import * from "./schemas/auth_user"
import * from "./schemas/order_product"
import * from "./schemas/business"

/*
DOCUMENTATION DE LA BASE DE DONNÉES

Pour obtenir une liste à jour des fonctions et procédures, utilisez db_functions.sql
Les index sont définis directement dans les modèles Prisma avec @@index
Les triggers automatiques Supabase ne sont pas documentés ici
*/

// ======= FONCTIONS ET PROCÉDURES MÉTIER ESSENTIELLES =======

/* 1. Gestion des Commandes */
// create_order_with_items (Function)
// Description: Crée une commande et ses items de manière atomique
// Paramètres: p_userId, p_serviceId, p_addressId, p_isRecurring, p_items[]
// Retourne: Détails de la commande créée

// cleanup_old_orders (Function)
// Description: Archive les commandes terminées > 30 jours
// Paramètre: days_threshold (défaut: 30)
// Retourne: Nombre d'archives créées

/* 2. Système d'Affiliation */
// process_affiliate_commission (Procedure)
// Description: Traite les commissions directes et indirectes
// Paramètres: p_order_id, p_order_amount, p_affiliate_code
// Règles métier:
// - Commission directe = 40% du montant * taux selon parrainage:
//   * 20% si ≥ 20 parrainages
//   * 15% si ≥ 10 parrainages
//   * 10% par défaut
// - Commission indirecte = 10% de la commission directe (pour le parent)

// update_affiliate_level (Procedure)
// Description: Met à jour le niveau d'un affilié selon ses gains totaux
// Paramètre: p_affiliate_id
// Action: Ajuste le niveau selon les seuils de gains définis

/* 3. Gestion des Retraits */
// process_withdrawal_request (Procedure)
// Description: Traite une demande de retrait
// Paramètres: p_affiliate_id, p_amount
// Règles métier:
// - Montant minimum: 25000 FCFA
// - Compte affilié doit être ACTIF
// - Solde suffisant requis

// approve_withdrawal (Procedure)
// Description: Approuve un retrait en attente
// Paramètre: p_withdrawal_id
// Actions: 
// - Vérifie statut PENDING
// - Change statut vers APPROVED

// reject_withdrawal (Procedure)
// Description: Rejette un retrait avec remboursement
// Paramètres: p_withdrawal_id, p_reason
// Actions:
// - Change statut vers REJECTED
// - Rembourse le montant au solde de l'affilié

Note: Les autres fonctions et triggers sont soit automatiquement générés par 
Supabase, soit servent uniquement à la maintenance interne de la base de données.
Pour plus de detailler sur les differente detaille d'une fonction ou d'une Procedure 
nous pouvons execuer la commande approprier pour voir les detaille de la fonction ou de la pro

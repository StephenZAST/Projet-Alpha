[
  {
    "procedure_name": "process_affiliate_commission",
    "procedure_definition": "CREATE OR REPLACE PROCEDURE public.process_affiliate_commission(IN p_order_id uuid, IN p_order_amount numeric, IN p_affiliate_code character varying)\n LANGUAGE plpgsql\nAS $procedure$\r\nDECLARE\r\n    v_affiliate_id UUID;\r\n    v_parent_id UUID;\r\n    v_commission_rate DECIMAL;\r\n    v_commission_amount DECIMAL;\r\n    v_level_id UUID;\r\n    v_current_date TIMESTAMPTZ;\r\nBEGIN\r\n    -- Récupérer la date courante\r\n    v_current_date := CURRENT_TIMESTAMP;\r\n\r\n    -- Récupérer l'affilié principal\r\n    SELECT id, parent_affiliate_id, commission_rate, level_id\r\n    INTO v_affiliate_id, v_parent_id, v_commission_rate, v_level_id\r\n    FROM affiliate_profiles\r\n    WHERE affiliate_code = p_affiliate_code AND is_active = true;\r\n\r\n    IF v_affiliate_id IS NULL THEN\r\n        RAISE EXCEPTION 'Affiliate not found or inactive';\r\n    END IF;\r\n\r\n    -- Calculer la commission principale\r\n    v_commission_amount := (p_order_amount * v_commission_rate / 100);\r\n\r\n    -- Insérer la transaction de commission principale\r\n    INSERT INTO commission_transactions (\r\n        id,\r\n        affiliate_id,\r\n        order_id,\r\n        amount,\r\n        status,\r\n        created_at\r\n    ) VALUES (\r\n        gen_random_uuid(),\r\n        v_affiliate_id,\r\n        p_order_id,\r\n        v_commission_amount,\r\n        'PENDING',\r\n        v_current_date\r\n    );\r\n\r\n    -- Mettre à jour les statistiques de l'affilié\r\n    UPDATE affiliate_profiles\r\n    SET \r\n        commission_balance = commission_balance + v_commission_amount,\r\n        total_earned = total_earned + v_commission_amount,\r\n        monthly_earnings = monthly_earnings + v_commission_amount,\r\n        updated_at = v_current_date\r\n    WHERE id = v_affiliate_id;\r\n\r\n    -- Traiter la commission du parent si existant\r\n    WHILE v_parent_id IS NOT NULL LOOP\r\n        -- Récupérer les infos du parent\r\n        SELECT id, parent_affiliate_id, commission_rate\r\n        INTO v_affiliate_id, v_parent_id, v_commission_rate\r\n        FROM affiliate_profiles\r\n        WHERE id = v_parent_id AND is_active = true;\r\n\r\n        IF v_affiliate_id IS NOT NULL THEN\r\n            -- Calculer la commission indirecte (10% de la commission principale)\r\n            v_commission_amount := (v_commission_amount * 0.10);\r\n\r\n            -- Insérer la transaction de commission indirecte\r\n            INSERT INTO commission_transactions (\r\n                id,\r\n                affiliate_id,\r\n                order_id,\r\n                amount,\r\n                status,\r\n                created_at\r\n            ) VALUES (\r\n                gen_random_uuid(),\r\n                v_affiliate_id,\r\n                p_order_id,\r\n                v_commission_amount,\r\n                'PENDING',\r\n                v_current_date\r\n            );\r\n\r\n            -- Mettre à jour les statistiques du parent\r\n            UPDATE affiliate_profiles\r\n            SET \r\n                commission_balance = commission_balance + v_commission_amount,\r\n                total_earned = total_earned + v_commission_amount,\r\n                monthly_earnings = monthly_earnings + v_commission_amount,\r\n                updated_at = v_current_date\r\n            WHERE id = v_affiliate_id;\r\n        END IF;\r\n    END LOOP;\r\nEND;\r\n$procedure$\n"
  },
  {
    "procedure_name": "process_affiliate_commission",
    "procedure_definition": "CREATE OR REPLACE PROCEDURE public.process_affiliate_commission(IN p_order_id uuid, IN p_order_amount numeric, IN p_affiliate_code text)\n LANGUAGE plpgsql\nAS $procedure$\r\nDECLARE\r\n    v_affiliate_id UUID;\r\n    v_direct_commission DECIMAL;\r\n    v_indirect_commission DECIMAL;\r\n    v_parent_id UUID;\r\nBEGIN\r\n    -- Récupérer l'ID de l'affilié\r\n    SELECT id, parent_affiliate_id\r\n    INTO v_affiliate_id, v_parent_id\r\n    FROM affiliate_profiles\r\n    WHERE affiliate_code = p_affiliate_code AND is_active = true;\r\n\r\n    IF v_affiliate_id IS NULL THEN\r\n        RAISE EXCEPTION 'Affiliate not found or inactive';\r\n    END IF;\r\n\r\n    -- Calculer la commission directe en utilisant total_referrals\r\n    SELECT (p_order_amount * 0.4) * (\r\n        CASE\r\n            WHEN total_referrals >= 20 THEN 0.20 -- 20%\r\n            WHEN total_referrals >= 10 THEN 0.15 -- 15%\r\n            ELSE 0.10 -- 10%\r\n        END\r\n    )\r\n    INTO v_direct_commission\r\n    FROM affiliate_profiles\r\n    WHERE id = v_affiliate_id;\r\n\r\n    -- Créer la transaction de commission directe\r\n    INSERT INTO commissionTransactions (\r\n        id,\r\n        affiliate_id,\r\n        order_id,\r\n        amount,\r\n        type,\r\n        status,\r\n        created_at\r\n    ) VALUES (\r\n        gen_random_uuid(),\r\n        v_affiliate_id,\r\n        p_order_id,\r\n        v_direct_commission,\r\n        'COMMISSION',\r\n        'APPROVED',\r\n        NOW()\r\n    );\r\n\r\n    -- Mettre à jour le solde et les statistiques de l'affilié\r\n    UPDATE affiliate_profiles SET\r\n        commission_balance = commission_balance + v_direct_commission,\r\n        total_earned = total_earned + v_direct_commission,\r\n        monthly_earnings = monthly_earnings + v_direct_commission\r\n    WHERE id = v_affiliate_id;\r\n\r\n    -- Si l'affilié a un parent, traiter la commission indirecte\r\n    IF v_parent_id IS NOT NULL THEN\r\n        -- Calculer la commission indirecte (10% de la commission directe)\r\n        v_indirect_commission := v_direct_commission * 0.1;\r\n\r\n        -- Créer la transaction de commission indirecte\r\n        INSERT INTO commissionTransactions (\r\n            id,\r\n            affiliate_id,\r\n            order_id,\r\n            amount,\r\n            type,\r\n            status,\r\n            created_at\r\n        ) VALUES (\r\n            gen_random_uuid(),\r\n            v_parent_id,\r\n            p_order_id,\r\n            v_indirect_commission,\r\n            'INDIRECT_COMMISSION',\r\n            'APPROVED',\r\n            NOW()\r\n        );\r\n\r\n        -- Mettre à jour le solde et les statistiques du parent\r\n        UPDATE affiliate_profiles SET\r\n            commission_balance = commission_balance + v_indirect_commission,\r\n            total_earned = total_earned + v_indirect_commission,\r\n            monthly_earnings = monthly_earnings + v_indirect_commission\r\n        WHERE id = v_parent_id;\r\n    END IF;\r\n\r\n    -- Mettre à jour le niveau de l'affilié\r\n    CALL update_affiliate_level(v_affiliate_id);\r\nEND;\r\n$procedure$\n"
  },
  {
    "procedure_name": "update_affiliate_level",
    "procedure_definition": "CREATE OR REPLACE PROCEDURE public.update_affiliate_level(IN p_affiliate_id uuid)\n LANGUAGE plpgsql\nAS $procedure$\r\nDECLARE\r\n    v_total_earned DECIMAL;\r\n    v_new_level_id UUID;\r\nBEGIN\r\n    -- Récupérer le total des gains\r\n    SELECT total_earned INTO v_total_earned\r\n    FROM affiliate_profiles\r\n    WHERE id = p_affiliate_id;\r\n\r\n    -- Trouver le niveau approprié\r\n    SELECT id INTO v_new_level_id\r\n    FROM affiliate_levels\r\n    WHERE \"minEarnings\" <= v_total_earned\r\n    ORDER BY \"minEarnings\" DESC\r\n    LIMIT 1;\r\n\r\n    -- Mettre à jour le niveau de l'affilié\r\n    IF v_new_level_id IS NOT NULL THEN\r\n        UPDATE affiliate_profiles SET\r\n            level_id = v_new_level_id\r\n        WHERE id = p_affiliate_id;\r\n    END IF;\r\nEND;\r\n$procedure$\n"
  },
  {
    "procedure_name": "reset_monthly_earnings",
    "procedure_definition": "CREATE OR REPLACE PROCEDURE public.reset_monthly_earnings()\n LANGUAGE plpgsql\nAS $procedure$\r\nBEGIN\r\n    UPDATE affiliate_profiles\r\n    SET monthly_earnings = 0\r\n    WHERE is_active = true;\r\nEND;\r\n$procedure$\n"
  },
  {
    "procedure_name": "calculate_available_commission",
    "procedure_definition": "CREATE OR REPLACE FUNCTION public.calculate_available_commission(p_affiliate_id uuid)\n RETURNS numeric\n LANGUAGE plpgsql\nAS $function$\r\nDECLARE\r\n    v_total_commission DECIMAL;\r\nBEGIN\r\n    SELECT COALESCE(commission_balance, 0)\r\n    INTO v_total_commission\r\n    FROM affiliate_profiles\r\n    WHERE id = p_affiliate_id;\r\n\r\n    RETURN v_total_commission;\r\nEND;\r\n$function$\n"
  },
  {
    "procedure_name": "increment_referral_count",
    "procedure_definition": "CREATE OR REPLACE FUNCTION public.increment_referral_count(p_affiliate_id uuid)\n RETURNS integer\n LANGUAGE plpgsql\nAS $function$\r\nDECLARE\r\n    v_new_count INTEGER;\r\nBEGIN\r\n    UPDATE affiliate_profiles\r\n    SET total_referrals = total_referrals + 1\r\n    WHERE id = p_affiliate_id\r\n    RETURNING total_referrals INTO v_new_count;\r\n\r\n    RETURN v_new_count;\r\nEND;\r\n$function$\n"
  },
  {
    "procedure_name": "process_withdrawal_request",
    "procedure_definition": "CREATE OR REPLACE PROCEDURE public.process_withdrawal_request(IN p_affiliate_id uuid, IN p_amount numeric)\n LANGUAGE plpgsql\nAS $procedure$\r\nDECLARE\r\n    v_current_balance DECIMAL;\r\n    v_min_withdrawal DECIMAL := 25000; -- Montant minimum de retrait en FCFA\r\nBEGIN\r\n    -- Vérifier le statut de l'affilié\r\n    IF NOT EXISTS (\r\n        SELECT 1 FROM affiliate_profiles\r\n        WHERE id = p_affiliate_id\r\n        AND is_active = true\r\n        AND status = 'ACTIVE'\r\n    ) THEN\r\n        RAISE EXCEPTION 'Affiliate account is not active';\r\n    END IF;\r\n\r\n    -- Récupérer le solde actuel\r\n    SELECT commission_balance INTO v_current_balance\r\n    FROM affiliate_profiles\r\n    WHERE id = p_affiliate_id;\r\n\r\n    -- Vérifier le montant minimum\r\n    IF p_amount < v_min_withdrawal THEN\r\n        RAISE EXCEPTION 'Minimum withdrawal amount is % FCFA', v_min_withdrawal;\r\n    END IF;\r\n\r\n    -- Vérifier le solde disponible\r\n    IF v_current_balance < p_amount THEN\r\n        RAISE EXCEPTION 'Insufficient balance. Available: % FCFA', v_current_balance;\r\n    END IF;\r\n\r\n    -- Créer la transaction de retrait\r\n    INSERT INTO commission_transactions (\r\n        id,\r\n        affiliate_id,\r\n        amount,\r\n        type,\r\n        status,\r\n        created_at,\r\n        updated_at\r\n    ) VALUES (\r\n        gen_random_uuid(),\r\n        p_affiliate_id,\r\n        -p_amount,\r\n        'WITHDRAWAL',\r\n        'PENDING',\r\n        NOW(),\r\n        NOW()\r\n    );\r\n\r\n    -- Mettre à jour le solde de l'affilié\r\n    UPDATE affiliate_profiles\r\n    SET commission_balance = commission_balance - p_amount,\r\n        updated_at = NOW()\r\n    WHERE id = p_affiliate_id;\r\nEND;\r\n$procedure$\n"
  },
  {
    "procedure_name": "reject_withdrawal",
    "procedure_definition": "CREATE OR REPLACE PROCEDURE public.reject_withdrawal(IN p_withdrawal_id uuid, IN p_reason text)\n LANGUAGE plpgsql\nAS $procedure$\r\nDECLARE\r\n    v_affiliate_id UUID;\r\n    v_amount DECIMAL;\r\nBEGIN\r\n    -- Récupérer les informations du retrait\r\n    SELECT affiliate_id, ABS(amount)\r\n    INTO v_affiliate_id, v_amount\r\n    FROM commission_transactions\r\n    WHERE id = p_withdrawal_id\r\n    AND type = 'WITHDRAWAL'\r\n    AND status = 'PENDING';\r\n\r\n    IF NOT FOUND THEN\r\n        RAISE EXCEPTION 'Withdrawal not found or not in pending status';\r\n    END IF;\r\n\r\n    -- Mettre à jour le statut de la transaction\r\n    UPDATE commission_transactions\r\n    SET status = 'REJECTED',\r\n        updated_at = NOW()\r\n    WHERE id = p_withdrawal_id;\r\n\r\n    -- Rembourser le montant sur le solde de l'affilié\r\n    UPDATE affiliate_profiles\r\n    SET commission_balance = commission_balance + v_amount,\r\n        updated_at = NOW()\r\n    WHERE id = v_affiliate_id;\r\nEND;\r\n$procedure$\n"
  }
]